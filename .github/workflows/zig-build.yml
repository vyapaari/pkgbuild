name: Zig Mingw-w64 Build

on:
  push:
    branches: [main, master]
    paths: ['PKGBUILD', '.github/workflows/zig-build.yml']
  pull_request:
    branches: [main, master]
    paths: ['PKGBUILD']
  workflow_dispatch:

env:
  ZIG_VERSION: "0.15.1"
  BUILD_JOBS: 2
  MINGW_ARCH: mingw64
  MINGW_PREFIX: /mingw64

jobs:
  build-zig:
    runs-on: windows-latest
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Setup Git for Windows SDK
      uses: git-for-windows/setup-git-for-windows-sdk@v1
      with:
        flavor: makepkg-git

    - name: Install build dependencies
      shell: bash
      run: |
        set -euo pipefail
        echo "Updating pacman database..."
        pacman -Sy --noconfirm
        echo "Installing Mingw-w64 build dependencies..."
        pacman -S --noconfirm --needed \
          mingw-w64-x86_64-llvm \
          mingw-w64-x86_64-clang \
          mingw-w64-x86_64-lld \
          mingw-w64-x86_64-zlib \
          mingw-w64-x86_64-zstd \
          mingw-w64-x86_64-cmake \
          mingw-w64-x86_64-ninja \
          mingw-w64-x86_64-gcc \
          base-devel \
          git

    - name: Setup environment properly
      shell: bash
      run: |
        echo "Setting up proper build environment..."
        # Source the profile to get proper environment variables
        source /etc/profile
        
        # Set up proper PATH for Mingw-w64
        export PATH="/mingw64/bin:/usr/bin:/bin"
        export MSYSTEM=MINGW64
        
        echo "Final PATH: $PATH"
        echo "MSYSTEM: $MSYSTEM"
        
        # Test basic commands
        command -v cmake && cmake --version | head -1 || echo "CMake not working"
        command -v ninja && ninja --version || echo "Ninja not working"
        command -v gcc && gcc --version | head -1 || echo "GCC not working"
        command -v git && git --version || echo "Git not working"

    - name: Download and extract Zig source
      shell: bash
      run: |
        set -euo pipefail
        echo "Downloading Zig source..."
        
        # Use direct URL since PKGBUILD parsing is complex
        source_url="https://ziglang.org/download/$ZIG_VERSION/zig-$ZIG_VERSION.tar.xz"
        echo "Downloading from: $source_url"
        
        curl -L --connect-timeout 30 --max-time 600 -o zig-source.tar.xz "$source_url"
        
        # Extract source
        echo "Extracting Zig source..."
        tar -xf zig-source.tar.xz
        mv "zig-$ZIG_VERSION" zig-source

    - name: Configure build environment
      shell: bash
      run: |
        set -euo pipefail
        echo "Preparing build environment..."
        cd zig-source
        
        # Create build directory
        mkdir -p build
        cd build
        
        # Create config files that might be missing
        mkdir -p ../stage1
        cat > ../stage1/config.h.in << EOF
#pragma once
#define ZIG_VERSION_STRING "$ZIG_VERSION"
#define ZIG_VERSION_MAJOR 0
#define ZIG_VERSION_MINOR 15
#define ZIG_VERSION_PATCH 1
EOF

        cat > ../stage1/config.zig.in << EOF
pub const version_string = "$ZIG_VERSION";
pub const version_major = 0;
pub const version_minor = 15;
pub const version_patch = 1;
EOF

        # Create config for self-hosted build
        cat > config.zig << EOF
pub const version_string = "$ZIG_VERSION";
pub const version_major = 0;
pub const version_minor = 15;
pub const version_patch = 1;
pub const enable_llvm = true;
pub const enable_zlib = true;
pub const enable_zstd = true;
pub const target = "x86_64-windows-gnu";
pub const optimize = "ReleaseSafe";
EOF

    - name: Build Zig (Stage 1 - CMake)
      shell: bash
      run: |
        set -euo pipefail
        echo "Starting CMake build (Stage 1)..."
        
        # Set up proper environment
        source /etc/profile
        export PATH="/mingw64/bin:/usr/bin:/bin"
        export MSYSTEM=MINGW64
        
        cd zig-source/build
        
        echo "Testing tools availability..."
        command -v cmake && cmake --version | head -1
        command -v ninja && ninja --version
        command -v gcc && gcc --version | head -1
        
        # Configure with CMake
        echo "Configuring with CMake..."
        MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX=" \
        cmake .. -GNinja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX="$MINGW_PREFIX" \
          -DZIG_SHARED_LLVM=ON \
          -DZIG_USE_LLD=ON \
          -DZIG_VERSION="$ZIG_VERSION" \
          -DZIG_TARGET="x86_64-windows-gnu" \
          -DZIG_OPTIMIZE="ReleaseSafe" \
          -DZIG_STATIC_ZLIB=OFF \
          -DZIG_STATIC_ZSTD=OFF 2>&1 | tee cmake-configure.log
        
        echo "Building with limited parallelism..."
        ninja -j"$BUILD_JOBS" -l"$BUILD_JOBS" 2>&1 | tee cmake-build.log
        
        # Verify zig2 was built
        if [ -f "zig2.exe" ]; then
          echo "✓ zig2.exe built successfully"
          ./zig2.exe version || echo "Version check continued despite error"
        else
          echo "✗ zig2.exe not found - checking what was built"
          ls -la *.exe || echo "No executables found"
          exit 1
        fi

    - name: Build Zig (Stage 2 - Self-hosted compiler)
      shell: bash
      run: |
        set -euo pipefail
        echo "Building self-hosted compiler with zig2 (Stage 2)..."
        cd zig-source/build
        
        # Build minimal compiler
        ./zig2.exe build-exe ../src/main.zig \
          -femit-bin=minizig.exe \
          -OReleaseSafe \
          -Dbuild_options=config.zig 2>&1 | tee stage2-build.log
        
        if [ -f "minizig.exe" ]; then
          echo "✓ minizig.exe built successfully"
          ./minizig.exe version
        else
          echo "✗ minizig.exe build failed - trying fallback without build_options"
          ./zig2.exe build-exe ../src/main.zig \
            -femit-bin=minizig.exe \
            -OReleaseSafe 2>&1 | tee stage2-fallback.log
          
          if [ -f "minizig.exe" ]; then
            echo "✓ minizig.exe built with fallback method"
            ./minizig.exe version
          else
            echo "✗ Both stage2 build attempts failed"
            exit 1
          fi
        fi

    - name: Build Zig (Stage 3 - Final optimized compiler)
      shell: bash
      run: |
        set -euo pipefail
        echo "Building final stage3 compiler..."
        cd zig-source/build
        
        if [ -f "minizig.exe" ]; then
          ./minizig.exe build \
            --prefix stage3 \
            --zig-lib-dir ../lib \
            -Dversion-string="$ZIG_VERSION" \
            -Dtarget=x86_64-windows-gnu \
            -Doptimize=ReleaseSafe \
            --verbose 2>&1 | tee stage3-build.log
          
          if [ -f "stage3/bin/zig.exe" ]; then
            echo "✓ Final Zig compiler built successfully"
            ./stage3/bin/zig.exe version
            ./stage3/bin/zig.exe targets
          else
            echo "✗ Final compiler build failed"
            exit 1
          fi
        else
          echo "✗ No minizig.exe found for stage3 build"
          exit 1
        fi

    - name: Test the built compiler
      shell: bash
      run: |
        set -euo pipefail
        echo "Testing the built compiler..."
        cd zig-source/build
        
        if [ -f "stage3/bin/zig.exe" ]; then
          # Basic functionality tests
          ./stage3/bin/zig.exe version
          ./stage3/bin/zig.exe targets
          
          # Simple compile test
          echo 'const std = @import("std");
pub fn main() void {
    std.debug.print("Hello, Zig!\n", .{});}' > test.zig
          
          ./stage3/bin/zig.exe build-exe test.zig
          ./test.exe
          
          echo "✓ All compiler tests passed"
        else
          echo "✗ No compiler found for testing"
          exit 1
        fi

    - name: Create package structure
      shell: bash
      run: |
        set -euo pipefail
        echo "Creating mingw-w64 package structure..."
        cd zig-source/build
        
        # Create package directory structure
        mkdir -p "pkg/$MINGW_PREFIX"/{bin,lib,share/licenses/zig}
        
        # Install final compiler binary
        install -Dm755 stage3/bin/zig.exe "pkg/$MINGW_PREFIX/bin/zig.exe"
        
        # Install standard library
        cp -r ../lib "pkg/$MINGW_PREFIX/lib/zig"
        
        # Install license
        install -Dm644 ../LICENSE "pkg/$MINGW_PREFIX/share/licenses/zig/LICENSE"
        
        # Create package metadata
        mkdir -p pkg/.MTREE
        cat > pkg/.MTREE/package << EOF
#mtree
./usr time=$(date +%s)
./usr/bin time=$(date +%s)
./usr/bin/zig.exe time=$(date +%s) mode=755
./usr/lib time=$(date +%s)
./usr/lib/zig time=$(date +%s)
./usr/share time=$(date +%s)
./usr/share/licenses time=$(date +%s)
./usr/share/licenses/zig time=$(date +%s)
./usr/share/licenses/zig/LICENSE time=$(date +%s) mode=644
EOF

    - name: Create package archive
      shell: bash
      run: |
        set -euo pipefail
        echo "Creating mingw-w64 package archive..."
        cd zig-source/build/pkg
        
        # Create package
        tar -cf - .MTREE * | zstd -z -19 - > "../../mingw-w64-x86_64-zig-$ZIG_VERSION-1-any.pkg.tar.zst"
        cd ../..
        
        # Verify package was created
        if [ -f "mingw-w64-x86_64-zig-$ZIG_VERSION-1-any.pkg.tar.zst" ]; then
          echo "✓ Package created successfully"
          ls -la "mingw-w64-x86_64-zig-$ZIG_VERSION-1-any.pkg.tar.zst"
        else
          echo "✗ Package creation failed"
          exit 1
        fi

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: zig-mingw64-package
        path: |
          zig-source/mingw-w64-x86_64-zig-*.pkg.tar.zst
          zig-source/build/stage3/bin/zig.exe

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          zig-source/build/*.log

    - name: Upload failure artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failure-artifacts
        path: |
          zig-source/build/
          zig-source/